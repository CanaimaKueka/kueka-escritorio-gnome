#!/bin/sh -e
#
# ==============================================================================
# PAQUETE: canaima-escritorio-gnome
# ARCHIVO: postinst
# DESCRIPCIÓN: Configura el sistema despues la instalación del paquete.
# COPYRIGHT:
#  (C) 2010 Luis Alejandro Martínez Faneyth <martinez.faneyth@gmail.com>
# LICENCIA: GPL3
# ==============================================================================
#
# Este programa es software libre. Puede redistribuirlo y/o modificarlo bajo los
# términos de la Licencia Pública General de GNU (versión 3).

ERROR() {
	printf "\033[1;31m${1}\033[0m\n"
}

ADVERTENCIA() {
	printf "\033[1;33m${1}\033[0m\n"
}

EXITO() {
	printf "\033[1;32m${1}\033[0m\n"
}

ALTERNATIVES="/etc/default/prelink /etc/default/rcS /etc/inittab /etc/xdg/user-dirs.defaults /etc/locale.nopurge /etc/adduser.conf /etc/NetworkManager/NetworkManager.conf"

ADDGROUPS="lp cdrom floppy audio dip dialout video plugdev netdev bluetooth lpadmin powerdev scanner users fuse"

case ${1} in
	configure|'')
		for ALT in ${ALTERNATIVES}; do
			ALTNAME="$( basename "${ALT}" )"

			if which ucf >/dev/null; then
				ucf "/usr/share/canaima-escritorio-gnome/alternatives/${ALTNAME}" "/etc/canaima-escritorio-gnome/alternatives/${ALTNAME}"
			fi

			if which ucfr >/dev/null; then
				ucfr canaima-escritorio-gnome "/etc/canaima-escritorio-gnome/alternatives/${ALTNAME}"
			fi

			ADVERTENCIA "Añadiendo alternativa para el archivo \"${ALT}\" ..."
			update-alternatives --force --install "${ALT}" "${ALTNAME}" "/etc/canaima-escritorio-gnome/alternatives/${ALTNAME}" 60
		done

		# ¿No existe la carpeta escritorio?
		if [ ! -d /etc/skel/Escritorio ]; then
			if [ -h /etc/skel/Escritorio ] || [ -f /etc/skel/Escritorio ]; then
				rm -rf /etc/skel/Escritorio
			fi

			mkdir -p /etc/skel/Escritorio
			ADVERTENCIA "Creando carpeta Escritorio en /etc/skel/ ..."
		fi 

		# ¿Existe un enlace simbólico llamado Desktop?
		# ¿Y una carpeta llamada Escritorio?
		if [ -h /etc/skel/Desktop ] && [ -d /etc/skel/Escritorio ]; then
			# Borra el enlace simbólico
			rm -rf /etc/skel/Desktop
			ADVERTENCIA "Removiendo enlace de escritorio Desktop en /etc/skel/ ..."
		fi

		# ¿Existe un enlace simbólico llamado Escritorio?
		# ¿Y una carpeta llamada Desktop?
		if [ -h /etc/skel/Escritorio ] && [ -d /etc/skel/Desktop ]; then
			# Borra el enlace simbólico
			rm -rf /etc/skel/Escritorio
			# y renombra la carpeta a Escritorio
			mv /etc/skel/Desktop /etc/skel/Escritorio
			ADVERTENCIA "Borrando enlace simbólico Escritorio y renombrando carpeta Desktop a Escritorio en /etc/skel/ ..."
		fi

		# ¿Existen dos directorios con el mismo propósito?
		if [ -d /etc/skel/Escritorio ] && [ -d /etc/skel/Desktop ]; then
			# Mueve el contenido de Desktop a Escritorio
			if [ $( ls -1 /etc/skel/Desktop | wc -l ) -gt 0 ]; then
    				mv /etc/skel/Desktop/* /etc/skel/Escritorio/
			fi

			# Borra la carpeta Desktop
			rm -rf /etc/skel/Desktop
			ADVERTENCIA "Moviendo el contenido de la carpeta Desktop a Escritorio y borrando Desktop en /etc/skel/ ..."
		fi

		# Para cada usuario en /home/ ...
		for USERNAME in $( ls -1 "/home/" ); do
			# Y en caso de que el usuario sea un usuario activo (existente en /etc/shadow) ...
			if [ $( grep -c "${USERNAME}:.*:.*:.*:.*:.*:::" /etc/shadow ) -eq 1 ] \
			&& [ $( grep -c "${USERNAME}:.*:.*:.*:.*:.*:/bin/.*sh" /etc/passwd ) -eq 1 ] \
			&& [ -d "/home/${USERNAME}/.config" ]; then

				# ¿No existe la carpeta Escritorio?
				if [ ! -d "/home/${USERNAME}/Escritorio" ]; then
					if [ -h "/home/${USERNAME}/Escritorio" ] \
					|| [ -f "/home/${USERNAME}/Escritorio" ]; then
						rm -rf "/home/${USERNAME}/Escritorio"
					fi

					mkdir "/home/${USERNAME}/Escritorio"
					chown -R ${USERNAME}:${USERNAME} "/home/${USERNAME}/Escritorio"
					ADVERTENCIA "Creando carpeta Escritorio en /home/${USERNAME} ..."
				fi

				# ¿Existe un enlace simbólico llamado Desktop?
				# ¿Y una carpeta llamada Escritorio?
				if [ -h "/home/${USERNAME}/Desktop" ] && [ -d "/home/${USERNAME}/Escritorio" ]; then
					# Borra el enlace simbólico
					rm -f "/home/${USERNAME}/Desktop"
					ADVERTENCIA "Removiendo enlace de escritorio Desktop en /home/${USERNAME} ..."
				fi

				# ¿Existe un enlace simbólico llamado Escritorio?
				# ¿Y una carpeta llamada Desktop?
				if [ -h "/home/${USERNAME}/Escritorio" ] && [ -d "/home/${USERNAME}/Desktop" ]; then
					# Borra el enlace simbólico
					rm -f "/home/${USERNAME}/Escritorio"

					# y renombra la carpeta a Escritorio
					mv "/home/${USERNAME}/Desktop" "/home/${USERNAME}/Escritorio"
					chown -R ${USERNAME}:${USERNAME} "/home/${USERNAME}/Escritorio"
					ADVERTENCIA "Borrando enlace simbólico Escritorio y renombrando carpeta Desktop a Escritorio en /home/${USERNAME} ..."
				fi

				# ¿Existen dos directorios con el mismo propósito?
				if [ -d "/home/${USERNAME}/Escritorio" ] && [ -d "/home/${USERNAME}/Desktop" ]; then
					# Mueve el contenido de Desktop a Escritorio
					if [ $( ls -1 "/home/${USERNAME}/Desktop" | wc  -l ) -gt 0 ]; then
			    			mv "/home/${USERNAME}/Desktop/*" "/home/${USERNAME}/Escritorio/"
					fi

					chown -R ${USERNAME}:${USERNAME} "/home/${USERNAME}/Escritorio"
					# Borra la carpeta Desktop
					rm -rf "/home/${USERNAME}/Desktop"
					ADVERTENCIA "Moviendo el contenido de la carpeta Desktop a Escritorio y borrando Desktop en /home/${USERNAME} ..."
				fi

				# Configuremos XDG para que use como locale "es_VE" y
				# Escritorio como carpeta de usuario predeterminada

				cp "/etc/skel/.config/user-dirs.locale" "/home/${USERNAME}/.config/"
				cp "/etc/skel/.config/user-dirs.dirs" "/home/${USERNAME}/.config/"
				chown -R ${USERNAME}:${USERNAME} "/home/${USERNAME}/.config"

				# Actualicemos la configuración
				if [ -x "$( which xdg-user-dirs-update )" ]; then
					su ${USERNAME} --command "xdg-user-dirs-update" || true
					su ${USERNAME} --command "xdg-user-dirs-update --force" || true
					EXITO "Carpetas de usuario actualizadas para '"${USERNAME}"'"
				fi

				for ADD in ${ADDGROUPS}; do
					for VAL in $( cat /etc/group | awk -F: '{print $1}' ); do
						if [ "${ADD}" = "${VAL}" ]; then
							adduser "${USERNAME}" "${ADD}" || true
						fi
					done
				done
			fi
		done
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
	;;

	*)

		ERROR "postinst no reconoce el argumento '"${1}"'" >&2
		exit 1

	;;

esac

#DEBHELPER#

exit 0
